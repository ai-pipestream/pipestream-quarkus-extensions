name: Create a Release

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Release type (patch=current version, minor/major=bump)'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

      skip_build:
        description: 'Skip build verification'
        type: boolean
        default: false

      dry_run:
        description: 'Dry run (show versions without tagging)'
        type: boolean
        default: false

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Configure Git for releases
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Use GITHUB_TOKEN for git operations (pushing tags)
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/ai-pipestream/pipestream-platform.git
          git fetch --tags

      - name: Build verification
        if: inputs.skip_build == false
        env:
          GRADLE_OPTS: -Xmx2048m -XX:MaxMetaspaceSize=512m
        run: |
          echo "Running build verification..."
          ./gradlew buildAll --no-daemon
          echo "Build successful!"

      - name: Calculate platform version
        id: version
        run: |
          # Get current version from BOM (source of truth for platform version)
          CURRENT=$(./gradlew :bom:currentVersion -q -Prelease.quiet 2>&1 | tail -1)
          
          if [ -z "$CURRENT" ] || [[ "$CURRENT" == *"FAILURE"* ]] || [[ "$CURRENT" == *"error"* ]]; then
            echo "‚ùå Failed to get version from BOM" >&2
            exit 1
          fi
          
          echo "Current platform version: $CURRENT"
          
          # Calculate new version based on bump type
          BUMP_TYPE="${{ inputs.bump_type }}"
          
          if [ "$BUMP_TYPE" == "patch" ]; then
            # Strip SNAPSHOT (release current version)
            NEW=${CURRENT%-SNAPSHOT}
            if ! [[ "$NEW" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "‚ùå Invalid version format: $NEW (expected X.Y.Z)" >&2
              exit 1
            fi
          elif [ "$BUMP_TYPE" == "minor" ]; then
            BASE=${CURRENT%-SNAPSHOT}
            IFS='.' read -r major minor patch <<< "$BASE"
            NEW="$major.$((minor + 1)).0"
          elif [ "$BUMP_TYPE" == "major" ]; then
            BASE=${CURRENT%-SNAPSHOT}
            IFS='.' read -r major minor patch <<< "$BASE"
            NEW="$((major + 1)).0.0"
          else
            echo "‚ùå Invalid bump_type: $BUMP_TYPE" >&2
            exit 1
          fi
          
          echo "New platform version: $NEW"
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "new=$NEW" >> $GITHUB_OUTPUT

      - name: Release all components
        id: release
        run: |
          CURRENT="${{ steps.version.outputs.current }}"
          NEW="${{ steps.version.outputs.new }}"
          BUMP_TYPE="${{ inputs.bump_type }}"
          DRY_RUN="${{ inputs.dry_run }}"
          
          # Determine release command based on bump type
          if [ "$BUMP_TYPE" == "patch" ]; then
            RELEASE_CMD="-Prelease.version=$NEW"
          elif [ "$BUMP_TYPE" == "minor" ]; then
            RELEASE_CMD="-Prelease.versionIncrementer=incrementMinor"
          elif [ "$BUMP_TYPE" == "major" ]; then
            RELEASE_CMD="-Prelease.versionIncrementer=incrementMajor"
          fi
          
          # Skip verifyRelease task entirely (we do build verification separately)
          # Use -x to skip the task, and disable checks as backup
          RELEASE_PARAMS="$RELEASE_CMD -x verifyRelease -Prelease.disableChecks -Prelease.disableSnapshotsCheck --no-daemon"
          
          echo "## Platform Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platform Version:** \`$CURRENT\` ‚Üí \`$NEW\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Tag |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-----|" >> $GITHUB_STEP_SUMMARY
          
          # Function to release a component
          release_component() {
            local component_name=$1
            local ext_dir=$2
            local gradle_task=$3
            local tag_prefix=$4
            
            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "Releasing: $component_name"
            echo "Version:   $NEW"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            
            local expected_tag="${tag_prefix}${NEW}"
            
            # Skip verifyRelease only for dynamic-grpc (has integration-tests that cause concurrency issues)
            local skip_verify=""
            if [ "$component_name" == "dynamic-grpc" ]; then
              skip_verify="-x verifyRelease"
            fi
            
            if [ "$DRY_RUN" == "true" ]; then
              echo "üîç DRY RUN - Would create tag: $expected_tag"
              echo "| $component_name | \`$expected_tag\` |" >> $GITHUB_STEP_SUMMARY
              return 0
            fi
            
            # Check if tag exists
            if git rev-parse "$expected_tag" >/dev/null 2>&1; then
              echo "‚ö†Ô∏è  Tag $expected_tag already exists, skipping..."
              echo "| $component_name | \`$expected_tag\` (exists) |" >> $GITHUB_STEP_SUMMARY
              return 0
            fi
            
            # Release component (with conditional verifyRelease skip)
            if [ -n "$ext_dir" ]; then
              cd "$ext_dir" || exit 1
              if ../gradlew "$gradle_task" $RELEASE_PARAMS $skip_verify; then
                cd .. || exit 1
                echo "‚úÖ Successfully released $component_name"
                echo "| $component_name | \`$expected_tag\` |" >> $GITHUB_STEP_SUMMARY
              else
                cd .. || exit 1
                echo "‚ùå Failed to release $component_name" >&2
                exit 1
              fi
            else
              if ./gradlew "$gradle_task" $RELEASE_PARAMS $skip_verify; then
                echo "‚úÖ Successfully released $component_name"
                echo "| $component_name | \`$expected_tag\` |" >> $GITHUB_STEP_SUMMARY
              else
                echo "‚ùå Failed to release $component_name" >&2
                exit 1
              fi
            fi
          }
          
          # Release all components in order (BOM last since it depends on others)
          # Order: extensions first, then BOM
          release_component "devservices" "pipestream-quarkus-devservices" "release" "devservices-v"
          release_component "apicurio" "quarkus-apicurio-registry-protobuf" "release" "apicurio-v"
          release_component "dynamic-grpc" "quarkus-dynamic-grpc-extension" "release" "dynamic-grpc-v"
          release_component "service-registration" "pipestream-service-registration-extension" "release" "service-registration-v"
          release_component "tika4-shaded" "tika4-shaded" "release" "tika-v"
          
          # BOM last (depends on all other components)
          release_component "bom" "" ":bom:release" "bom-v"
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$DRY_RUN" == "true" ]; then
            echo "**Dry run complete - no tags were created**" >> $GITHUB_STEP_SUMMARY
            echo "dry_run=true" >> $GITHUB_OUTPUT
          else
            echo "**‚úÖ Platform release complete!**" >> $GITHUB_STEP_SUMMARY
            echo "All components released with version \`$NEW\`" >> $GITHUB_STEP_SUMMARY
            echo "dry_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Trigger publish workflows
        if: steps.release.outputs.dry_run != 'true'
        env:
          GH_WORKFLOW_TOKEN: ${{ secrets.GH_WORKFLOW_TOKEN }}
        run: |
          # Use GH_WORKFLOW_TOKEN ONLY for triggering workflows via API
          NEW="${{ steps.version.outputs.new }}"
          
          echo "Triggering publish workflows for platform version $NEW..."
          
          # Components to trigger workflows for
          COMPONENTS=("devservices" "apicurio" "dynamic-grpc" "service-registration" "tika4-shaded" "bom")
          
          for EXTENSION in "${COMPONENTS[@]}"; do
            echo "Triggering workflow for: $EXTENSION"
            curl -X POST \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: token ${GH_WORKFLOW_TOKEN}" \
              "https://api.github.com/repos/ai-pipestream/pipestream-platform/actions/workflows/publish-extensions.yml/dispatches" \
              -d "{\"ref\":\"main\",\"inputs\":{\"extension\":\"$EXTENSION\"}}" || echo "‚ö†Ô∏è  Failed to trigger workflow for $EXTENSION"
          done
          
          echo "‚úÖ Workflow triggers completed"
