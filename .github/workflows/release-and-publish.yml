name: Release and Publish

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type (patch, minor, major, or manual)'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
          - manual
      manual_version:
        description: 'Manual version (only used if release_type is manual, e.g., 4.1.0)'
        required: false
        type: string

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build and test
        run: ./gradlew clean build shadowJar --no-daemon --stacktrace

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: build/libs/tika4-shaded-*.jar
          retention-days: 1

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine version
        id: version
        run: |
          if [ "${{ inputs.release_type }}" = "manual" ]; then
            VERSION="${{ inputs.manual_version }}"
          else
            # Get current version from axion-release
            # axion-release often prints lines like: "Project version: 0.1.1-SNAPSHOT"
            # Extract the raw semver (with optional -SNAPSHOT) from the output safely
            CURRENT_VERSION=$(./gradlew currentVersion -q --no-daemon | tail -1 | sed -E 's/.*([0-9]+\.[0-9]+\.[0-9]+(-SNAPSHOT)?).*/\1/')
            echo "Resolved current version string: $CURRENT_VERSION"

            # Parse version components (remove -SNAPSHOT if present)
            CLEAN_VERSION=$(echo "$CURRENT_VERSION" | sed 's/-SNAPSHOT//')
            IFS='.' read -r MAJOR MINOR PATCH <<< "$CLEAN_VERSION"

            # Increment based on release type
            case "${{ inputs.release_type }}" in
              major)
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                ;;
              minor)
                MINOR=$((MINOR + 1))
                PATCH=0
                ;;
              patch)
                PATCH=$((PATCH + 1))
                ;;
            esac

            VERSION="${MAJOR}.${MINOR}.${PATCH}"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Create and push tag
        run: |
          git tag -a "${{ steps.version.outputs.tag }}" -m "Release ${{ steps.version.outputs.version }}"
          git push origin "${{ steps.version.outputs.tag }}"

      - name: Build release artifacts
        run: ./gradlew clean build shadowJar --no-daemon

      - name: Configure GPG (if available)
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        if: env.GPG_PRIVATE_KEY != ''
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import

      - name: Publish to Maven Central
        env:
          MAVEN_CENTRAL_USERNAME: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          MAVEN_CENTRAL_PASSWORD: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: ./gradlew publishAllPublicationsToCentralPortal --no-daemon --stacktrace

      - name: Publish to GitHub Packages
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./gradlew publish -PskipCentral=true --no-daemon --stacktrace

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.version }}
          body: |
            ## Tika 4 Shaded - Release ${{ steps.version.outputs.version }}

            ### Maven Coordinates
            ```xml
            <dependency>
                <groupId>ai.pipestream</groupId>
                <artifactId>tika4-shaded</artifactId>
                <version>${{ steps.version.outputs.version }}</version>
            </dependency>
            ```

            ### Gradle (Kotlin DSL)
            ```kotlin
            implementation("ai.pipestream:tika4-shaded:${{ steps.version.outputs.version }}")
            ```

            ### Gradle (Groovy DSL)
            ```groovy
            implementation 'ai.pipestream:tika4-shaded:${{ steps.version.outputs.version }}'
            ```

            ### Maven Central
            Available from Maven Central (no additional repository configuration needed):
            ```xml
            <dependency>
                <groupId>ai.pipestream</groupId>
                <artifactId>tika4-shaded</artifactId>
                <version>${{ steps.version.outputs.version }}</version>
            </dependency>
            ```

            ### GitHub Packages (Alternative)
            Also available from GitHub Packages:
            ```xml
            <repository>
                <id>github</id>
                <url>https://maven.pkg.github.com/ai-pipestream/tika4-shaded</url>
            </repository>
            ```

            ### What's Included
            - Apache Tika 4.0 Core
            - Standard Parsers Package
            - Scientific Parser Package
            - OCR Parser Module
            - All dependencies shaded under `ai.pipestream.shaded.tika`
          files: |
            build/libs/tika4-shaded-${{ steps.version.outputs.version }}.jar
          draft: false
          prerelease: false
          generate_release_notes: true
